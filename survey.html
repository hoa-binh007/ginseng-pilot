<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Survey</title>
  <link rel="stylesheet" href="app.css"/>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="small" data-de="Umfrage" data-vi="Kh·∫£o s√°t" data-en="Survey"></div>
      <div class="lang">
        <button id="btnDe" type="button">üá©üá™</button>
        <button id="btnVi" type="button">üáªüá≥</button>
        <button id="btnEn" type="button">üá¨üáß</button>
      </div>
    </div>

    <!-- META (optional) -->
    <div class="pilot-meta" style="margin:12px 0; padding:12px; border:1px solid #333; border-radius:10px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <label style="flex:1; min-width:160px;">
          <div style="font-weight:600; margin-bottom:6px;" data-de="Rolle (optional)" data-vi="Vai tr√≤ (t√πy ch·ªçn)" data-en="Role (optional)"></div>
          <select id="role" style="width:100%; padding:8px;">
            <option value="" data-de="(√ºberspringen)" data-vi="(b·ªè qua)" data-en="(skip)"></option>
            <option value="consumer" data-de="Konsument" data-vi="Ng∆∞·ªùi d√πng" data-en="Consumer"></option>
            <option value="expert" data-de="Experte" data-vi="Chuy√™n gia" data-en="Expert"></option>
          </select>
        </label>

        <label style="flex:1; min-width:160px;">
          <div style="font-weight:600; margin-bottom:6px;" data-de="Stadt (optional)" data-vi="Th√†nh ph·ªë (t√πy ch·ªçn)" data-en="City (optional)"></div>
          <select id="city" style="width:100%; padding:8px;">
            <option value="" data-de="(√ºberspringen)" data-vi="(b·ªè qua)" data-en="(skip)"></option>
            <option value="Germany" data-de="Deutschland" data-vi="ƒê·ª©c" data-en="Germany"></option>
            <option value="Saigon">Saigon</option>
            <option value="DaLat">Da Lat</option>
            <option value="Hue">Hu·∫ø</option>
            <option value="QuangBinh">Qu·∫£ng B√¨nh</option>
            <option value="Other" data-de="Andere" data-vi="Kh√°c" data-en="Other"></option>
          </select>
        </label>
      </div>
      <div style="margin-top:8px; font-size:0.9em; opacity:0.8;" data-de="Hilft uns beim Vergleich der Standorte." data-vi="Gi√∫p ch√∫ng t√¥i so s√°nh gi·ªØa c√°c th√†nh ph·ªë." data-en="Helps us compare cities/experts."></div>
    </div>

    <div class="card">
      <h1 data-de="Schnellumfrage (14 Fragen + 2 optionale Angaben)"
          data-vi="Kh·∫£o s√°t nhanh (14 c√¢u + 2 m·ª•c t√πy ch·ªçn)"
          data-en="Quick survey (14 questions + 2 optional fields)"></h1>

      <p data-de="Anonym. Schnell tippen."
         data-vi="Ch·ªçn nhanh. ·∫®n danh."
         data-en="Tap quickly. Anonymous."></p>

      <form id="surveyForm">

        <h2 data-de="TEIL A ‚Äì WAHRNEHMUNG" data-vi="PH·∫¶N A ‚Äì C·∫¢M NH·∫¨N" data-en="PART A ‚Äì PERCEPTION"></h2>

        <div class="q">
          <div class="q-title" data-de="Q1. Bitterer Geschmack" data-vi="Q1. V·ªã ƒë·∫Øng" data-en="Q1. Bitter taste"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q1_bitter" value="strong" required><span data-de="Stark" data-vi="ƒê·∫Øng r√µ" data-en="Strong"></span></label>
            <label class="choice"><input type="radio" name="q1_bitter" value="mild"><span data-de="Mild" data-vi="ƒê·∫Øng nh·∫π" data-en="Mild"></span></label>
            <label class="choice"><input type="radio" name="q1_bitter" value="hardly"><span data-de="Kaum" data-vi="H·∫ßu nh∆∞ kh√¥ng ƒë·∫Øng" data-en="Hardly"></span></label>
            <label class="choice"><input type="radio" name="q1_bitter" value="none"><span data-de="Nicht bitter" data-vi="Kh√¥ng ƒë·∫Øng" data-en="Not bitter"></span></label>
          </div>
        </div>

        <div class="q">
          <div class="q-title" data-de="Q2. Leichter s√º√üer Nachgeschmack?" data-vi="Q2. H·∫≠u v·ªã ng·ªçt nh·∫π?" data-en="Q2. Slight sweet aftertaste?"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q2_sweet" value="yes" required><span data-de="Ja" data-vi="C√≥" data-en="Yes"></span></label>
            <label class="choice"><input type="radio" name="q2_sweet" value="little"><span data-de="Ein bisschen" data-vi="C√≥ m·ªôt ch√∫t" data-en="A little"></span></label>
            <label class="choice"><input type="radio" name="q2_sweet" value="unsure"><span data-de="Nicht sicher" data-vi="Kh√¥ng ch·∫Øc" data-en="Not sure"></span></label>
            <label class="choice"><input type="radio" name="q2_sweet" value="no"><span data-de="Nein" data-vi="Kh√¥ng" data-en="No"></span></label>
          </div>
        </div>

        <div class="q">
          <div class="q-title" data-de="Q3. Mehr Speichelfluss?" data-vi="Q3. Nhi·ªÅu n∆∞·ªõc b·ªçt h∆°n?" data-en="Q3. More saliva?"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q3_saliva" value="yes_clear" required><span data-de="Ja, deutlich" data-vi="C√≥, r√µ" data-en="Yes, clearly"></span></label>
            <label class="choice"><input type="radio" name="q3_saliva" value="yes_light"><span data-de="Ja, leicht" data-vi="C√≥, nh·∫π" data-en="Yes, a little"></span></label>
            <label class="choice"><input type="radio" name="q3_saliva" value="unsure"><span data-de="Nicht sicher" data-vi="Kh√¥ng ch·∫Øc" data-en="Not sure"></span></label>
            <label class="choice"><input type="radio" name="q3_saliva" value="no"><span data-de="Nein" data-vi="Kh√¥ng" data-en="No"></span></label>
          </div>
        </div>

        <div class="q">
          <div class="q-title" data-de="Q4. Gesamteindruck" data-vi="Q4. C·∫£m nh·∫≠n chung" data-en="Q4. Overall perception"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q4_type" value="health_machine" required><span data-de="Gesundheitsgetr√§nk (Maschine)" data-vi="ƒê·ªì u·ªëng s·ª©c kh·ªèe (m√°y)" data-en="Health drink (machine)"></span></label>
            <label class="choice"><input type="radio" name="q4_type" value="medicinal"><span data-de="Naturmedizin / Kr√§uter" data-vi="D∆∞·ª£c li·ªáu / thu·ªëc ƒê√¥ng y" data-en="Herbal / medicinal"></span></label>
            <label class="choice"><input type="radio" name="q4_type" value="coffee_machine"><span data-de="√Ñhnlich wie Kaffee (Maschine)" data-vi="Gi·ªëng c√† ph√™ (m√°y)" data-en="Similar to coffee (machine)"></span></label>
          </div>
        </div>

        <div class="q">
          <div class="q-title" data-de="Q5. Bevorzugte Servierform" data-vi="Q5. B·∫°n th√≠ch u·ªëng‚Ä¶" data-en="Q5. Preferred serving"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q5_temp" value="hot" required><span data-de="Hei√ü" data-vi="N√≥ng" data-en="Hot"></span></label>
            <label class="choice"><input type="radio" name="q5_temp" value="cold"><span data-de="Kalt / Eis" data-vi="L·∫°nh / ƒê√°" data-en="Cold / with ice"></span></label>
            <label class="choice"><input type="radio" name="q5_temp" value="either"><span data-de="Egal" data-vi="C√°ch n√†o c≈©ng ƒë∆∞·ª£c" data-en="Either is fine"></span></label>
          </div>
        </div>

        <!-- PART B -->
        <h2 data-de="TEIL B ‚Äì PREIS & WERT" data-vi="PH·∫¶N B ‚Äì GI√Å & GI√Å TR·ªä" data-en="PART B ‚Äì PRICE & VALUE"></h2>
        <p class="small"
           data-de="Stimme den Aussagen zu (1 = gar nicht, 5 = vollkommen)."
           data-vi="M·ª©c ƒë·ªô ƒë·ªìng √Ω (1 = kh√¥ng ƒë·ªìng √Ω, 5 = ho√†n to√†n ƒë·ªìng √Ω)."
           data-en="Rate your agreement (1 = disagree, 5 = strongly agree)."></p>

        <div class="q" data-qscale="q6_tooCheap">
          <div class="q-title"
               data-de="Q6. Der Preis wirkt so niedrig, dass ich an der Qualit√§t zweifle."
               data-vi="Q6. Gi√° c√≥ v·∫ª qu√° th·∫•p khi·∫øn t√¥i nghi ng·ªù v·ªÅ ch·∫•t l∆∞·ª£ng."
               data-en="Q6. The price seems so low that I doubt the quality."></div>
          <input type="hidden" name="q6_tooCheap" value="">
          <div class="scale">
            <button class="dot" type="button" data-scale="q6_tooCheap" data-value="1">1</button>
            <button class="dot" type="button" data-scale="q6_tooCheap" data-value="2">2</button>
            <button class="dot" type="button" data-scale="q6_tooCheap" data-value="3">3</button>
            <button class="dot" type="button" data-scale="q6_tooCheap" data-value="4">4</button>
            <button class="dot" type="button" data-scale="q6_tooCheap" data-value="5">5</button>
          </div>
        </div>

        <div class="q" data-qscale="q7_goodValue">
          <div class="q-title"
               data-de="Q7. F√ºr die erwartete Qualit√§t ist der Preis fair."
               data-vi="Q7. V·ªõi ch·∫•t l∆∞·ª£ng t√¥i k·ª≥ v·ªçng, m·ª©c gi√° n√†y l√† h·ª£p l√Ω."
               data-en="Q7. For the quality I expect, the price is fair."></div>
          <input type="hidden" name="q7_goodValue" value="">
          <div class="scale">
            <button class="dot" type="button" data-scale="q7_goodValue" data-value="1">1</button>
            <button class="dot" type="button" data-scale="q7_goodValue" data-value="2">2</button>
            <button class="dot" type="button" data-scale="q7_goodValue" data-value="3">3</button>
            <button class="dot" type="button" data-scale="q7_goodValue" data-value="4">4</button>
            <button class="dot" type="button" data-scale="q7_goodValue" data-value="5">5</button>
          </div>
        </div>

        <div class="q" data-qscale="q8_expOk">
          <div class="q-title"
               data-de="Q8. Der Preis wirkt eher hoch ‚Äì ich w√ºrde es trotzdem kaufen."
               data-vi="Q8. Gi√° c√≥ v·∫ª h∆°i cao ‚Äì nh∆∞ng t√¥i v·∫´n s·∫Ω mua."
               data-en="Q8. The price seems rather high ‚Äì but I would still buy it."></div>
          <input type="hidden" name="q8_expOk" value="">
          <div class="scale">
            <button class="dot" type="button" data-scale="q8_expOk" data-value="1">1</button>
            <button class="dot" type="button" data-scale="q8_expOk" data-value="2">2</button>
            <button class="dot" type="button" data-scale="q8_expOk" data-value="3">3</button>
            <button class="dot" type="button" data-scale="q8_expOk" data-value="4">4</button>
            <button class="dot" type="button" data-scale="q8_expOk" data-value="5">5</button>
          </div>
        </div>

        <div class="q" data-qscale="q9_tooExp">
          <div class="q-title"
               data-de="Q9. Der Preis ist so hoch, dass ich es nicht kaufen w√ºrde."
               data-vi="Q9. Gi√° cao ƒë·∫øn m·ª©c t√¥i s·∫Ω kh√¥ng mua."
               data-en="Q9. The price is so high that I would not buy it."></div>
          <input type="hidden" name="q9_tooExp" value="">
          <div class="scale">
            <button class="dot" type="button" data-scale="q9_tooExp" data-value="1">1</button>
            <button class="dot" type="button" data-scale="q9_tooExp" data-value="2">2</button>
            <button class="dot" type="button" data-scale="q9_tooExp" data-value="3">3</button>
            <button class="dot" type="button" data-scale="q9_tooExp" data-value="4">4</button>
            <button class="dot" type="button" data-scale="q9_tooExp" data-value="5">5</button>
          </div>
        </div>

        <!-- PART C -->
        <h2 data-de="TEIL C ‚Äì KAUFVERHALTEN" data-vi="PH·∫¶N C ‚Äì MUA H√ÄNG" data-en="PART C ‚Äì BUYING"></h2>

        <div class="q">
          <div class="q-title" data-de="Q10. Konsumh√§ufigkeit" data-vi="Q10. T·∫ßn su·∫•t u·ªëng" data-en="Q10. Consumption frequency"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q10_freq" value="daily" required><span data-de="T√§glich" data-vi="M·ªói ng√†y" data-en="Daily"></span></label>
            <label class="choice"><input type="radio" name="q10_freq" value="2_3wk"><span data-de="2-3 mal pro Woche" data-vi="2‚Äì3 l·∫ßn / tu·∫ßn" data-en="2-3 times/week"></span></label>
            <label class="choice"><input type="radio" name="q10_freq" value="1wk"><span data-de="W√∂chentlich" data-vi="1 l·∫ßn / tu·∫ßn" data-en="Once a week"></span></label>
            <label class="choice"><input type="radio" name="q10_freq" value="occasion"><span data-de="Gelegentlich" data-vi="Th·ªânh tho·∫£ng" data-en="Occasionally"></span></label>
          </div>
        </div>

        <div class="q">
          <div class="q-title" data-de="Q11. Bevorzugte Packung" data-vi="Q11. B·∫°n th√≠ch mua‚Ä¶" data-en="Q11. Preferred pack"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q11_pack" value="single" required><span data-de="Einzelne Kapsel" data-vi="T·ª´ng vi√™n" data-en="Single capsule"></span></label>
            <label class="choice"><input type="radio" name="q11_pack" value="box10"><span data-de="10er Box" data-vi="H·ªôp 10 vi√™n" data-en="Box of 10"></span></label>
            <label class="choice"><input type="radio" name="q11_pack" value="box30"><span data-de="30er Box" data-vi="H·ªôp 30 vi√™n" data-en="Box of 30"></span></label>
            <label class="choice"><input type="radio" name="q11_pack" value="gift"><span data-de="Geschenkbox üéÅ" data-vi="H·ªôp qu√† üéÅ" data-en="Gift box üéÅ"></span></label>
          </div>
        </div>

        <div class="q">
          <div class="q-title" data-de="Q12. Vertrauensw√ºrdigster Kaufort" data-vi="Q12. N∆°i tin t∆∞·ªüng nh·∫•t" data-en="Q12. Most trusted place"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q12_channel" value="pharmacy" required><span data-de="Apotheke" data-vi="Nh√† thu·ªëc" data-en="Pharmacy"></span></label>
            <label class="choice"><input type="radio" name="q12_channel" value="supermarket"><span data-de="Supermarkt" data-vi="Si√™u th·ªã" data-en="Supermarket"></span></label>
            <label class="choice"><input type="radio" name="q12_channel" value="online"><span data-de="Offizielle Webseite" data-vi="Website ch√≠nh th·ª©c" data-en="Official website"></span></label>
          </div>
        </div>

        <!-- PART D -->
        <h2 data-de="TEIL D ‚Äì OPTIONAL" data-vi="PH·∫¶N D ‚Äì T√ôY CH·ªåN" data-en="PART D ‚Äì OPTIONAL"></h2>

        <div class="q">
          <div class="q-title" data-de="Q13. Aktuelle T√§tigkeit" data-vi="Q13. B·∫°n hi·ªán l√†m‚Ä¶" data-en="Q13. Current occupation"></div>
          <div class="choices">
            <label class="choice"><input type="radio" name="q13_work" value="office"><span data-de="B√ºroangestellter" data-vi="Nh√¢n vi√™n vƒÉn ph√≤ng" data-en="Office worker"></span></label>
            <label class="choice"><input type="radio" name="q13_work" value="self"><span data-de="Selbstst√§ndig" data-vi="T·ª± kinh doanh" data-en="Self-employed"></span></label>
            <label class="choice"><input type="radio" name="q13_work" value="student"><span data-de="Student" data-vi="Sinh vi√™n" data-en="Student"></span></label>
            <label class="choice"><input type="radio" name="q13_work" value="home"><span data-de="Hausfrau/-mann" data-vi="N·ªôi tr·ª£" data-en="Homemaker"></span></label>
          </div>
        </div>

        <div class="q" data-qscale="q14_spend">
          <div class="q-title" data-de="Q14. Ausgaben f√ºr Gesundheit / Monat" data-vi="Q14. Chi cho s·ª©c kh·ªèe / th√°ng" data-en="Q14. Health spending / month"></div>
          <input type="hidden" name="q14_spend" value="">
          <div class="scale">
            <button class="dot" type="button" data-scale="q14_spend" data-value="1">1</button>
            <button class="dot" type="button" data-scale="q14_spend" data-value="2">2</button>
            <button class="dot" type="button" data-scale="q14_spend" data-value="3">3</button>
            <button class="dot" type="button" data-scale="q14_spend" data-value="4">4</button>
          </div>
        </div>

        <div class="footer">
          <button class="btn" type="submit" data-de="Senden" data-vi="G·ª≠i" data-en="Submit"></button>
        </div>

      </form>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    Ginseng.initLangButtons();
    Ginseng.renderI18n();

    // Robust: handle scale clicks + active state
    function setScaleActive(scaleName, value) {
      const hidden = document.querySelector('input[name="' + scaleName + '"]');
      if (hidden) hidden.value = String(value);

      // active class toggling (works even without CSS; you can style .dot.active later)
      document.querySelectorAll('button.dot[data-scale="' + scaleName + '"]').forEach(b => {
        if (b.dataset.value === String(value)) b.classList.add("active");
        else b.classList.remove("active");
      });
    }

    document.querySelectorAll("button.dot[data-scale]").forEach(btn => {
      btn.addEventListener("click", () => {
        // keep your original API call if it exists
        if (typeof Ginseng.setScale === "function") {
          Ginseng.setScale(btn.dataset.scale, btn.dataset.value);
        }
        // ensure robustness even if Ginseng.setScale is buggy
        setScaleActive(btn.dataset.scale, btn.dataset.value);
      });
    });

    function firstMissingScale(formEl, requiredScales) {
      for (const name of requiredScales) {
        const hidden = formEl.querySelector('input[name="' + name + '"]');
        if (!hidden) continue;
        if (!hidden.value) return name;
      }
      return null;
    }

    function scrollToScale(scaleName) {
      const block = document.querySelector('[data-qscale="' + scaleName + '"]');
      if (block && typeof block.scrollIntoView === "function") {
        block.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    document.getElementById("surveyForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const form = document.getElementById("surveyForm");

      // 1) Let browser validate radio required fields first
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // 2) Custom validation for scales (so it never "silently blocks")
      // Q6‚ÄìQ9 are mandatory; Q14 is optional (can be left empty)
      const missing = firstMissingScale(form, ["q6_tooCheap", "q7_goodValue", "q8_expOk", "q9_tooExp"]);
      if (missing) {
        scrollToScale(missing);
        alert(Ginseng.t({
          de: "Bitte beantworte auch die Preis-Fragen (Q6‚ÄìQ9) mit 1‚Äì5.",
          vi: "Vui l√≤ng tr·∫£ l·ªùi c√°c c√¢u v·ªÅ gi√° (Q6‚ÄìQ9) b·∫±ng thang 1‚Äì5.",
          en: "Please answer the price questions (Q6‚ÄìQ9) using 1‚Äì5."
        }));
        return;
      }

      const data = Ginseng.collectForm(form);

      // Include meta fields (role/city) so they are not lost
      const role = document.getElementById("role")?.value || "";
      const city = document.getElementById("city")?.value || "";

      const payload = {
        id: Ginseng.uuid(),
        ts: new Date().toISOString(),
        lang: localStorage.getItem("ginseng_lang") || "de",
        meta: { role, city },
        answers: data
      };

      try {
        await Ginseng.saveResponse(payload);
        window.location.href = "thanks.html";
      } catch (err) {
        alert(Ginseng.t({de:"Fehler.", vi:"L·ªói.", en:"Error."}));
      }
    });
  </script>
</body>
</html>
